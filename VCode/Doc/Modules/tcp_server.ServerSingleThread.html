<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>

<head>

<META NAME="GENERATOR" CONTENT="pythondoc 0.7 (Sat Feb 01 16:36:16 2003)">

<link rel="stylesheet" href="pythondoc.css" type="text/css">

<title>Class ServerSingleThread</title>
</head>

<body>
<P><A HREF="index.html">Table of contents</A> <A HREF="indices.html">Index</A></P>


<H1 CLASS="ClassName">class ServerSingleThread - Implements a TCP/IP based VoiceCode server.</H1>
<P CLASS="DeclaredIn">Declared in module <A HREF="tcp_server.html">tcp_server</A></P>

<H2 CLASS="ClassHierarchy">Inheritance hierarchy:</H2><P CLASS="ClassHierarchy">tcp_server.ServerSingleThread<BR>
&nbsp;&nbsp;Object.Object<BR>
</P>

<H2>Synopsis</H2>
<PRE CLASS="ClassDeclaration">
<SPAN CLASS="PyKeyword">class</SPAN> <SPAN CLASS="ClassName">ServerSingleThread</SPAN>(<A CLASS="DocLink" HREF="Object.Object.html">Object</A>):
    <SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.__init__</SPAN>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">editor_factory</SPAN>, <SPAN CLASS="Argument">test_suite=None</SPAN>, <SPAN CLASS="Argument">extra_opts=None</SPAN>, <SPAN CLASS="Argument">**args_super</SPAN>)
    <A CLASS="DocLink" HREF="#tcp_server.ServerSingleThread.handshake_listen_socks"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.handshake_listen_socks</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>)<SPAN CLASS="OneLiner"> # Invoked when a new socket connection was opened on VC_LISTEN port.</SPAN>
    <A CLASS="DocLink" HREF="#tcp_server.ServerSingleThread.handshake_talk_socks"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.handshake_talk_socks</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>)
    <A CLASS="DocLink" HREF="#tcp_server.ServerSingleThread.package_sock_pair"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.package_sock_pair</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">id</SPAN>, <SPAN CLASS="Argument">app_name</SPAN>, <SPAN CLASS="Argument">window</SPAN>, <SPAN CLASS="Argument">listen_sock</SPAN>, <SPAN CLASS="Argument">talk_sock</SPAN>, <SPAN CLASS="Argument">test_client=0</SPAN>)
    <A CLASS="DocLink" HREF="#tcp_server.ServerSingleThread.process_ready_socks"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.process_ready_socks</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>)<SPAN CLASS="OneLiner"> # Processes socket connections that have received new data.</SPAN>
    <A CLASS="DocLink" HREF="#tcp_server.ServerSingleThread.run"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">tcp_server.ServerSingleThread.run</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>)<SPAN CLASS="OneLiner"> # Start the server</SPAN>

    <SPAN CLASS="InheritsHead"># Inherited from Object.Object</SPAN>
    <SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">Object.Object.__init__</SPAN>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">**args_super</SPAN>)
    <A CLASS="DocLink" HREF="#Object.Object.decl_attrs"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">Object.Object.decl_attrs</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)<SPAN CLASS="OneLiner"> # Define new attributes for <EM>self</EM></SPAN>
    <A CLASS="DocLink" HREF="#Object.Object.deep_construct"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">Object.Object.deep_construct</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">this_class</SPAN>, <SPAN CLASS="Argument">attrs_this_class</SPAN>, <SPAN CLASS="Argument">args_super</SPAN>, <SPAN CLASS="Argument">new_default={}</SPAN>, <SPAN CLASS="Argument">enforce_value={}</SPAN>, <SPAN CLASS="Argument">exclude_bases={}</SPAN>)<SPAN CLASS="OneLiner"> # Build an instance of a class.</SPAN>
    <A CLASS="DocLink" HREF="#Object.Object.init_attrs"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">Object.Object.init_attrs</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)<SPAN CLASS="OneLiner"> # Initialises existing attributes</SPAN>
    <A CLASS="DocLink" HREF="#Object.Object.possibly_init_attrs"><SPAN CLASS="PyKeyword">def</SPAN> <SPAN CLASS="FunctionName">Object.Object.possibly_init_attrs</SPAN></A>(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)

</PRE><H2>Description</H2><P>
??? Update this documentation when the server is finalised ???</P>
<P>
<STRONG>INSTANCE ATTRIBUTES</STRONG></P>

<DL>

<DT>
[(socket, (STR, STR, STR, BOOL))] <EM>new_listen_socks=[]</EM>
<DD>Each entry is
a 2ple consiting of a new (uninitialised) socket on the VC_LISTEN
port, and data about that socket. The data is itself a 4ple
consisting of: (a) identifier of external editor, (b) name of the
external editor, (c) window handle of the external editor, and (d)
a flag indicating whether the client is expecting to be used for
regression testing. 
<DT>
<EM>[(socket, [None, None, None, None])] new_talk_socks</EM>
<DD>Like
 <EM>new_listen_socks</EM>, except sockets are on the VC_TALK port, and
 the data part of the 2ple is useless.
<DT>
{socket: STR} <EM>active_listen_socks={}</EM>
<DD>Key is a VC_LISTEN
sockets that HAS been initialised and associated with an
[AppStateMessaging]. Value is the [AppStateMessaging] instance
that's connected to the socket.
<DT>
[socket] *ready_socks*=[]
<DD>List of active VC_LISTEN socks which
are ready for input.
<DT>
<EM>threading.lock new_socks_lock</EM>
<DD>Lock used to make sure that the
 main thread doesn't access the lists <EM>new_listen_socks</EM>
 and <EM>new_talk_socks</EM> at the same time as the threads that listen
 for new socket connections.
<DT>
<EM>lock.lock ready_socks_lock</EM>
<DD>Lock for the list <EM>ready_socks</EM>.     
<DT>
[ListenForNewListenersThread] <EM>new_listener_server</EM>
<DD>Thread that
listens for new connections on the VC_LISTEN port.
<DT>
[ListenForNewTalkersThread] <EM>new_talker_server</EM>
<DD>Thread that
listens for new connections on the VC_TALK port.
<DT>
[CheckReadySocksThread] <EM>ready_socks_checker</EM>
<DD>This thread
monitors all the VC_LISTEN sockets to see if any of them has
received new data.
<DT>
<EM>PyHandle evt_new_listen_conn</EM>
<DD>Win32 event raised when a new
 socket connection is opened on VC_LISTEN port.
<DT>
<EM>PyHandle evt_new_talk_conn</EM>
<DD>Win32 event raised when a new
 socket connection is opened on VC_TALK port.
<DT>
<EM>PyHandle evt_sockets_ready</EM>
<DD>Win32 event raised when one of the
 active VC_LISTEN sockets has unread data.
<DT>
<EM>PyHandle evt_quit</EM>
<DD>Win32 event raised when we are shutting
 down the server.
<DT>
<EM>AppStateFactory editor_factory</EM>
<DD>factory for creating new
AppStateMessaging instances
<DT>
{STR : MediatorObject} <EM>active_meds</EM>
<DD>map from unique socket IDs
to active mediators driving external edtiors.
<DT>
STR <EM>test_suite=None</EM>
<DD>If not <EM>None</EM>, then upon connection by a
new editor run regression test suite <EM>test_suite</EM>.
</DL>
<P>
<STRONG>CLASS ATTRIBUTES</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<P>
..[AppStateMessaging] AppStateMessaging.AppStateMessaging.html
..[ListenForNewListenersThread] tcp_server.ListenForNewListenersThread.html
..[ListenForNewTalkersThread] tcp_server.ListenForNewTalkersThread.html
</P>
<H2 ID="tcp_server.ServerSingleThread.handshake_listen_socks" CLASS="Method">tcp_server.ServerSingleThread.handshake_listen_socks(<SPAN CLASS="Argument">self</SPAN>)</H2>
<P>Invoked when a new socket connection was opened on VC_LISTEN port.</P>

<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="tcp_server.ServerSingleThread.handshake_talk_socks" CLASS="Method">tcp_server.ServerSingleThread.handshake_talk_socks(<SPAN CLASS="Argument">self</SPAN>)</H2>
<P>None</P>

<P>
Does a handshake on a the new socket connection that were opened on
VC_LISTEN port.</P>
<P>
<STRONG>INPUTS</STRONG></P>
<P>
<EM>none</EM></P>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="tcp_server.ServerSingleThread.package_sock_pair" CLASS="Method">tcp_server.ServerSingleThread.package_sock_pair(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">id</SPAN>, <SPAN CLASS="Argument">app_name</SPAN>, <SPAN CLASS="Argument">window</SPAN>, <SPAN CLASS="Argument">listen_sock</SPAN>, <SPAN CLASS="Argument">talk_sock</SPAN>, <SPAN CLASS="Argument">test_client=0</SPAN>)</H2>
<P>None</P>

<P>
Packages a listen and talk socket into an
[AppStateMessaging] instance</P>
<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
STR <EM>id</EM>
<DD>The unique identifier assigned by VoiceCode to
that socket pair.
<DT>
STR <EM>app_name</EM>
<DD>Name of the external editor.
<DT>
STR <EM>window</EM>
<DD>window handle for the external editor.
<DT>
socket <EM>listen_sock</EM>
<DD>The listen socket
<DT>
socket <EM>talk_sock</EM>
<DD>The talk socket
<DT>
BOOL <EM>test_client</EM>
<DD>flag indicating whether or not the client
is expecting to be used for regression testing
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<P>
..[AppStateMessaging] messaging.AppStateMessaging.html</P>
<H2 ID="tcp_server.ServerSingleThread.process_ready_socks" CLASS="Method">tcp_server.ServerSingleThread.process_ready_socks(<SPAN CLASS="Argument">self</SPAN>)</H2>
<P>Processes socket connections that have received new data.</P>

<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="tcp_server.ServerSingleThread.run" CLASS="Method">tcp_server.ServerSingleThread.run(<SPAN CLASS="Argument">self</SPAN>)</H2>
<P>Start the server</P>

<P>
This method runs 3 threads that raise Win32 events respectively when:</P>

<UL>

<LI>a request for a new connections on VC_LISTEN port is
  received (*self.evt_new_listen_conn* event).
<LI>a request for a new connections on VC_PORT port is received
  (*self.evt_new_talk_conn* event)
<LI>one or more existing connections on VC_LISTEN port has
  unread data (*self.evt_sockets_ready* event)
</UL>
<P>
These events (plus *self.evt_quit*) are handled inside an
event loop run by this method.</P>
<P>
We need this event loop so that speech events can be processed
(actually, I think the speech events are just forwarded to
NatSpeak by calling pythoncom.PumpWaitingMessages()).</P>
<P>
Also, the reason why the above four events are not processed
directly in the threads that raise them, is that processing
the events involves invoking some natlink methods, and Natlink
does not behave well outside of the main thread.</P>
<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="Object.Object.decl_attrs" CLASS="Method">Object.Object.decl_attrs(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)</H2>
<P>Define new attributes for <EM>self</EM></P>

<P>
Attributes are directly through self.__dict__, thus bypassing safe
__setattr__.</P>
<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>{STR: ANY}</EM> attrs
<DD>dictionary with attribute name as the keys and
 initial values as the values.
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="Object.Object.deep_construct" CLASS="Method">Object.Object.deep_construct(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">this_class</SPAN>, <SPAN CLASS="Argument">attrs_this_class</SPAN>, <SPAN CLASS="Argument">args_super</SPAN>, <SPAN CLASS="Argument">new_default={}</SPAN>, <SPAN CLASS="Argument">enforce_value={}</SPAN>, <SPAN CLASS="Argument">exclude_bases={}</SPAN>)</H2>
<P>Build an instance of a class.</P>

<P>
Basically, this method:
- declares and initialise all attributes listed in <EM>attrs_this_class</EM>
- invokes the <EM>__init__</EM> of all superclasses (with the exclusion of those listed in *exclude_bases*), passing them arguments in <EM>args_super</EM></P>

<DL>

<DT>
<EM>CLASS</EM> this_class
<DD>Class that we want to build. This is a
 class object as opposed to the name of a class. Constructors
 of immediate superclasses of <EM>this_class</EM> are called
 automatically, except if they are listed in *{CLASS: 1}
 exclude_bases*.
<DT>
<EM>{STR: ANY}</EM> attrs_this_class
<DD>New attributes (and their
 values) defined by class <EM>this_class</EM>. The keys are the names
 of the attributes and the values are the values of the
 attributes (either default values or values passed to
 *this_class.__init__*). An attribute with the appropriate
 name will be declared automatically and initialsed to the
 value specified in <EM>attrs_this_class</EM>.
<DT>
<EM>{STR: ANY}</EM> args_super
<DD>Arguments received by
<EM>this_class.__init__</EM> but not recognised by it. These are
assumed to be arguments defined in the <EM>__init__</EM> of some
ancestor class and are just passed up the construction
chain. Keys of <EM>args_super</EM> correspond to the names of the
arguments and the values corresponds to the values received
for them by <EM>this_class.__init__</EM>
<DT>
<EM>{STR: ANY}</EM> new_default={}
<DD>Used to change the default
 value of an ancestor constructor argument. In other words, if
 <EM>this_class.__init__</EM> was called without specifying a value
 for an argument that's listed in <EM>new_default</EM>, the default
 value defined in <EM>new_default</EM> will be used instead of
 whatever default might be defined in the constructor
 of an ancestor class. However, if the constructor was called
 WITH a specific value for that argument, that specific value
 will be used instead of both the defaults defined in
 <EM>new_default</EM> and the constructor of ancestor classes. Keys
 of <EM>new_default</EM> correspond to argument names, and values
 correspond to the new default values. If you don't specify a
 value of <EM>new_default</EM>, it defaults to <EM>{}</EM>, which means that
 the defaults of none of the ancestor constructor arguments
 are redefined by <EM>this_class</EM>.
<DT>
<EM>{STR: ANY}</EM> enforce_value={}
<DD>Lists of arguments with
 enforced values. If the constructor is called with a value
 for an argument that is different from the value specified
 for it in <EM>enforce_value</EM>, then an <A HREF="Object.EnforcedConstrArg.html">EnforcedConstrArg</A>
 exception will be raised. Also, if the constructor is called
 without specifying a value for a particular argument, then
 the value defined in <EM>enforce_value</EM> (if it exists) will be
 used instead of whatever default might be defined in an
 ancestor class. Keys of <EM>enforce_value</EM> correspond to
 argument names and values correspond to the enforced
 values. If you don't specify a value for <EM>enforce_value</EM>, it
 defaults to <EM>{}</EM>, which means that <EM>this_class.__init__</EM> does
 not enforce the value of any argument.
<DT>
<EM>{CLASS: BOOL}</EM> exclude_bases
<DD>Immediate base classes whose
constructors should not be called automatically. If an
immediate superclass of <EM>this_class</EM> is listed in
<EM>exclude_bases</EM>, then we don't automatically call its
constructor. It is assumed that the programmer will call the
constructor manually in <EM>this_class.__init__</EM>. If you do not
specify a value for <EM>exclude_bases</EM>, it will default to <EM>{}</EM>,
which means that the constructor of all immediate super
classes will be called automatically.
</DL>
<H2 ID="Object.Object.init_attrs" CLASS="Method">Object.Object.init_attrs(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)</H2>
<P>Initialises existing attributes</P>

<P>
Attributes are only set if they already exist in
 <EM>self.__dict__</EM>. Otherwise, an <EM>AttributeError</EM> exception is
 raised (provided PY_DEBUG_OBJECT=1).</P>
<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>{STR: ANY}</EM> attrs
<DD>dictionary with attribute name as the keys and
 default values as the values.
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>
<H2 ID="Object.Object.possibly_init_attrs" CLASS="Method">Object.Object.possibly_init_attrs(<SPAN CLASS="Argument">self</SPAN>, <SPAN CLASS="Argument">attrs</SPAN>)</H2>
<P>None</P>

<P>
Initialises existing attributes, unless those attributes
already exist</P>
<P>
<STRONG>INPUTS</STRONG></P>

<DL>

<DT>
<EM>{STR: ANY}</EM> attrs
<DD>dictionary with attribute name as the keys and
 default values as the values.
</DL>
<P>
<STRONG>OUTPUTS</STRONG></P>

<DL>

<DT>
<EM>none</EM>
<DD>
</DL>

<HR>
<TABLE ALIGN="LEFT">
<TR><TD>
  <A HREF="http://validator.w3.org/check/referer" TARGET="validate">
    <IMG BORDER=0 SRC="http://validator.w3.org/images/vh40.gif"
     ALT="Valid HTML 4.0!" HEIGHT=31 WIDTH=88></A>
  <A HREF="http://www.w3.org/Style/CSS/Buttons">
    <IMG ALT="Made with CSS" BORDER=0 WIDTH=88 HEIGHT=31 
     SRC="http://www.w3.org/Style/CSS/Buttons/mwcos"></A>

</TD>
<TD STYLE="padding-left: 10">
  <SPAN CLASS="AUTHOR"></SPAN><BR>
  <SPAN CLASS="VERSION"></SPAN>
</TD>
</TABLE>

</body>
</html>
